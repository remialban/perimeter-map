<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Périmètre</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">

</head>

<body class="container">
    <h1 class="mt-3">Périmètre 10 km</h1>
    <hr>
    <p>Saisissez une adresse :</p>
    <div class="input-group">
        <span class="input-group-text" id="basic-addon1"><i class="bi bi-geo-alt"></i></span>
        <input type="text" class="form-control py-2 border-right-0 border" placeholder="Ecrivez votre adresse" id="address-input">
        <button class="btn btn-outline-secondary border-left-0 border" id="clearButton" type="button">
                <i class="bi bi-x"></i>
            </button>
    </div>
    <div class="list-group" id="list" style="position: absolute; z-index: 99999;width:100%">
    </div>
    <br>

    <div id="mapid" style="height: 500px"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function() {
            function setCookie(name, value, days) {
                var expires = "";
                if (days) {
                    var date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + (value || "") + expires + "; path=/perimeter-map;domain=remialban.github.io";
                //document.cookie = name + "=" + (value || "") + expires + "; path=/";

            }

            function getCookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }



            $('#toastCookie').toast('show');

            var inputAddress = document.getElementById("address-input")
            var list = document.getElementById("list")

            function api() {

                fetch("https://api-adresse.data.gouv.fr/search/?q=" + inputAddress.value).then((response) => {
                    if (response.ok) {
                        response.json().then((data) => {
                            addresses = data.features
                            list.innerHTML = ""
                            list.innerText = ""
                            $("#list").empty();
                            addresses.map((address) => {
                                $("#list").append(
                                    "<a href='#' class='list-group-item list-group-item-action item_address' data-latitude='" + address.geometry.coordinates[0] + "'' data-longitude='" + address.geometry.coordinates[1] + "'>" + address.properties.label + "</a>"
                                )

                            })
                        })



                    }
                })

            }
            $(document).on('click', '.item_address', function() {
                var element = $(this)
                $("#address-input").val(element.text())
                $("#list").empty()
                mise_a_jour_map(element.data("longitude"), element.data("latitude"))
                    // your function here
            });

            $("#clearButton").click(() => {
                $("#address-input").val("")
            })

            $("#address-input").on("input", function() {
                api()
            });
            var mymap = L.map('mapid').setView([43.927063, 2.198952], 11);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoicmVtaWFsYmFuODEiLCJhIjoiY2tuZGxkMng2MWlmMTJ2bXJtb3BmMTF3OSJ9.2ElAN4jWXxxMaLIhXyxV-Q'
            }).addTo(mymap)

            var circle = L.circle([43.927063, 2.198952], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 10000
            }).addTo(mymap)
            var marker = L.marker([43.927063, 2.198952]).addTo(mymap);

            function mise_a_jour_map(long, lat) {
                marker.setLatLng([long, lat])
                circle.setLatLng([long, lat])
                mymap.setView([long, lat], 11);
                console.log(long)
                setCookie("longitude", long, 9)
                setCookie("latitude", lat, 9)
            }

            //mise_a_jour_map(50, 2)
            $("body").click(() => {
                $("#list").empty()
            })
            console.log(getCookie("longitude"))
        });
    </script>
</body>

</html>